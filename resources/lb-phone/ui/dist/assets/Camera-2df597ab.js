import{u as h,r as n,q as o,$ as ve,A as H,bb as M,P as w,aA as X,p as c,bc as be,bd as Ce,be as Se,C as K,a as s,F as re,j as v,bf as ye,bg as Ae,bh as we,L as ne,s as $,bi as Oe,bj as se,bk as Pe,bl as Re,aU as Ie,a3 as ke,t as ie,a7 as Ne,b3 as Le,b as Me,U as Ve}from"./index-2acb14b9.js";function Ke(){const p=h(Me);h(K.CameraComponent);const z=h(M.Unlocked),oe=h(M.PassedFaceId),R=h(M.Visible);h(M.LockScreenVisible);const[F,O]=n.useState(!1),[i,T]=n.useState("Photo"),[V,G]=n.useState(!1),[ce,W]=n.useState(!1),[q,E]=n.useState(null),[b,Q]=n.useState(!1),[d,le]=n.useState(!1),[J,Y]=n.useState(0),[ue,x]=n.useState({}),f=h(Ve),m=h(H),B=n.useRef(null),U=n.useRef(null),C=n.useRef(null),u=n.useRef(null),I=n.useRef(!1),S=n.useRef(null),y=n.useRef(!1),g=["Video","Photo","Landscape"];n.useEffect(()=>{var e;y.current=!(f!=null&&f.visible)&&((e=m==null?void 0:m.active)==null?void 0:e.name)==="Camera"&&R},[C.current,f==null?void 0:f.visible,m==null?void 0:m.active,R]);const de=()=>{var e;o("info","Camera app is not active or open, pausing game render & releasing audio stream"),I.current=!1,(e=u.current)==null||e.pause(),S.current&&(se("Camera"),S.current=null),i==="Landscape"&&c("Camera",{action:"toggleLandscape",toggled:!1},"OK"),c("Camera",{action:"close"},"OK")},fe=async()=>{var r;if(I.current=!0,o("info","Camera app is active & open, initializing game render & audio stream"),u.current?u.current.paused&&u.current.resume():u.current=new Pe(C.current),!S.current){const t=await Re("Camera");if(!y.current){o("info","camera app is no longer open, releasing audio stream"),se("Camera");return}t&&(S.current=t)}c("Camera",{action:"open"},"OK"),c("Camera",{action:"flipCamera",value:b},"OK"),i==="Landscape"&&!((r=X)!=null&&r.value)?(c("Camera",{action:"toggleLandscape",toggled:!0},"OK"),w.Styles.Rotation.set(90)):i==="Video"&&c("Camera",{action:"toggleVideo",toggled:!0},"OK");const e=$.APPS.CAMERA.lastImage.value||await c("Camera",{action:"getLastImage"},Ie.Photos[0].src);e&&Z(e),I.current=!1};n.useEffect(()=>{if(o("info","Camera app active:",y.current),!C.current)return o("warning","Canvas ref is null");y.current&&I.current&&o("info","Camera app is already initializing, returning"),y.current?I.current||fe():de()},[y.current,C.current]),ve("camera:usedCommand",e=>{var r;if(f!=null&&f.visible||((r=m==null?void 0:m.active)==null?void 0:r.name)!=="Camera"||!R)return o("info","camera:usedCommand - camera is not active, returning");switch(e){case"toggleTaking":k();break;case"toggleFlip":Q(t=>!t);break;case"toggleFlash":G(t=>!t);break;case"leftMode":if(d)return;T(t=>{const a=g.indexOf(t);return a===0?g[g.length-1]:g[a-1]});break;case"rightMode":if(d)return;T(t=>{const a=g.indexOf(t);return a===g.length-1?g[0]:g[a+1]});break}}),n.useEffect(()=>{if(!U.current)return;let e=[];const t=setInterval(()=>{e.length>2&&(e=[]),e.push("."),U.current.innerText=ne("APPS.CAMERA.UPLOADING")+e.join("")},500);return()=>clearInterval(t)},[F]);const Z=(e,r)=>{if(r===void 0&&(r=ke(e)),r){const t=document.createElement("video");t.src=e,t.muted=!0,t.play();const a=document.createElement("canvas");if(!a)return;t.addEventListener("loadeddata",()=>{a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const P=a.toDataURL("image/png");B.current.style.backgroundImage=`url(${P})`,$.APPS.CAMERA.lastImage.set(P),a.remove(),t.remove()})}else B.current.style.backgroundImage=`url(${e})`,$.APPS.CAMERA.lastImage.set(e)};n.useEffect(()=>{if(!R)return()=>{H.patch({active:null}),z||M.LockScreenVisible.set(!0)}},[R]),n.useEffect(()=>{var r,t;if(d||!u.current)return;switch(i){case"Landscape":if((r=X)!=null&&r.value)return;x({marginRight:"9rem"}),w.Styles.Rotation.set(90);break;case"Video":w.Styles.Rotation.set(0),x({marginLeft:"12rem"});break;default:w.Styles.Rotation.set(0),x({marginLeft:"3rem"});break}if(i==="Landscape"){if((t=X)!=null&&t.value)return;u.current.resizeByAspect(16/9)}else(i==="Video"||i==="Photo")&&u.current.resizeByAspect(3/4);c("Camera",{action:"toggleLandscape",toggled:i==="Landscape"},"OK"),c("Camera",{action:"toggleVideo",toggled:i==="Video"},"OK");const e=window.innerWidth;e>1920&&u.current.setQuality(1920/e),i==="Photo"&&b?u.current.setXOffset(-.2):u.current.setXOffset(0)},[i]),n.useEffect(()=>{if(c("Camera",{action:"flipCamera",value:b},"OK"),!d){if(!y.current)return o("info","Camera app is not active, returning");i=="Photo"&&b?u.current.setXOffset(-.2):u.current.setXOffset(0)}},[z,b]);const _=n.useRef(!0),ee=async(e,r)=>{const t=ie(e.size/1e3,2);V&&c("toggleFlashlight",{toggled:!1},"OK");try{const a=await Ne(r?"Video":"Image",e);if(!a)throw new Error("Failed to upload media (URL is null)");return Z(a),o("info",`Saving ${r?"video":"photo"} to gallery (${t}kb) - ${a}, args(${a}, ${t}, ${b&&!r?"selfie":null})`),await Le(a,t,b&&!r?"selfie":null,!0),!0}catch(a){throw a}};n.useEffect(()=>{if(_.current){_.current=!1;return}if(V&&!d&&c("toggleFlashlight",{toggled:!1},"OK"),!d)return;const e=C.current.captureStream(p.videoOptions.fps),r=new AudioContext,t=new MediaStreamAudioDestinationNode(r);S.current?r.createMediaStreamSource(S.current).connect(t):r.createOscillator().connect(t),be("Camera",r,t);const a=[e.getVideoTracks()[0]];(S.current||p.recordNearbyVoices)&&a.unshift(t.stream.getAudioTracks()[0]);const P=new MediaStream(a),A=new MediaRecorder(P,{mimeType:"video/webm;codecs=vp9,opus",videoBitsPerSecond:p.videoOptions.bitrate*8*1e3});let D=0;const ge=A.audioBitsPerSecond+A.videoBitsPerSecond,te=setInterval(()=>{const l=(Date.now()-D)/1e3,j=ge*l/8/1024/1024,L=ie(j,2);L>=p.videoOptions.size&&(o("info",`Video file size limit reached (${L}mb)`),clearInterval(te),k())},100);let ae=[];A.ondataavailable=l=>{var N;((N=l==null?void 0:l.data)==null?void 0:N.size)>0&&ae.push(l.data)},A.onerror=l=>{o("error","error recording:",l)},A.onstop=async()=>{clearInterval(te);let l=Date.now()-D,N=new Blob(ae,{type:"video/webm"});r.close(),O(!0),Ce("Camera");const j=await Se(N,l,{logger:!1});try{await ee(j,!0),o("info","Video uploaded successfully"),O(!1)}catch(L){o("error","Could not upload video",L),O(!1),E(L.message),await new Promise(he=>setTimeout(he,1e4)),E(null)}},D=Date.now(),A.start();const pe=setInterval(()=>{if(J>=p.videoOptions.duration)return k();Y(l=>l+1>=p.videoOptions.duration?(k(),0):l+1)},1e3);return()=>{Y(0),clearInterval(pe),A.stop()}},[d]);const me=e=>{let r=(e%60).toString().padStart(2,"0"),t=(Math.floor(e/60)%60).toString().padStart(2,"0");return Math.floor(e/3600).toString().padStart(2,"0")+":"+t+":"+r},k=async()=>{var r,t;if(F)return o("info","Returning since an image is currently uploading");if(V&&await c("toggleFlashlight",{toggled:!0},"OK"),i=="Video"){await c("Camera",{action:"toggleHud",toggled:d},"OK"),le(a=>!a);return}await c("Camera",{action:"toggleHud",toggled:!1},"OK"),(t=(r=w.Settings.value)==null?void 0:r.sound)!=null&&t.silent||w.SoundManager.set({url:"./assets/sound/other/cameraShutter.mp3"}),W(!0),K.IndicatorVisible.set(!1),O(!0),o("info","Uploading image, converting to blob");const e=await new Promise(a=>C.current.toBlob(a,p.imageOptions.mime,p.imageOptions.quality));try{await ee(e,!1),o("info","Image uploaded successfully"),O(!1),K.IndicatorVisible.set(!0)}catch(a){o("error","Could not upload image",a),O(!1),E(a.message),K.IndicatorVisible.set(!0),await new Promise(P=>setTimeout(P,1e4)),E(null)}W(!1),c("Camera",{action:"toggleHud",toggled:!0},"OK")};return s(re,{children:v("div",{className:"camera-container",children:[v("div",{className:"camera-header",children:[s("div",{className:"flash",onClick:()=>G(e=>!e),children:!d&&V?s(ye,{}):s(Ae,{})}),i==="Video"&&v(re,{children:[s("div",{className:"timer",children:me(J)}),s("span",{})]})]}),v("div",{className:`camera-body ${i=="Landscape"?"rotate":""}`,children:[s("canvas",{ref:C,style:{visibility:ce?"hidden":"visible"}}),F&&v("div",{className:"loading",children:[s(we,{size:80,speed:1,color:"#ffffff"}),s("div",{className:"uploading",ref:U,children:"Uploading..."})]}),q&&s("div",{className:"loading",children:v("div",{className:"uploading",children:["Failed to upload, tell the server owner to check their API keys in lb-phone/server/apiKeys.lua",s("br",{}),s("br",{}),q]})})]}),v("div",{className:"camera-bottom",children:[s("div",{className:"camera-types",style:ue,children:g.map((e,r)=>s("div",{className:`${i===e&&"active"}`,onClick:()=>T(e),children:ne(`APPS.CAMERA.${e.toUpperCase()}`)},r))}),v("div",{className:"camera-buttons",children:[s("div",{className:"image-gallery",ref:B,onClick:()=>{!oe&&!z||(c("Camera",{action:"close"},"OK"),w.Styles.Rotation.set(0),H.patch({active:{name:"Photos",data:{photo:$.APPS.CAMERA.lastImage.value}}}))}}),s("div",{className:"camera-button",onClick:()=>k(),children:s("div",{className:"camera-button-container",children:s("div",{className:`camera-button-inner ${i=="Video"&&`${i} ${d==!0&&"Recording"}`}`})})}),s("div",{className:"flip-camera",onClick:()=>Q(e=>!e),children:s(Oe,{})})]})]})]})})}export{Ke as default};
